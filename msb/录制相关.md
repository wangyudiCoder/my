

### 录制分析和解决方案说明

[TOC]

#### 引言

* 问题由来

录制相关服务经常告警，后台发现有些视频没有回放及有遗漏录制。

* 参与人员

调研过程主要有张文诏、张超支持完成；作者：王愉迪。



![image-20190830150426517](/Users/wangyudi/Library/Application Support/typora-user-images/image-20190830150426517.png)



#### 当前逻辑

![image-20190827153644398](/Users/wangyudi/Library/Application Support/typora-user-images/image-20190827153644398.png)

##### 解读

###### 机器数量

目前共18台



###### 空间

单流文件（每节课）**1-1.5G**左右；混流**2-3G**左右；合流过程需要**5G**左右空间



###### 工作效率

录制单流每个流占大约 **2M**带宽 ，单机支持**50-70**个流，流必须**实时录制**；

合流最多一次**4个线程**，每个视频**20分钟**左右



###### 工作方式

单流录制好以后，需要合成；
如果无法满足实时录制，**停掉合成程序**，录制视频会**产生积压**



##### 压力问题

* CPU

  目前cpu消耗已经到最高，堆积视频无法即使做合成处理。

* 磁盘

  周末高峰期的视频夜里处理不完，第二天会出现新的视频需要合成，需要在下个周末到来前合完，才能确保后续录制和合成的稳定性。





#####  问题分析

######  当前效率：50个/台，共900实时

目前估算最多支持同时录制9百个视频（每台同时50个）的同时录制，如果按照每台现在的CPU处理能力第二天可以完成合成任务。

###### 实际压力：超过900

现在高峰期已经超过900节课同时录制，为保证实时录制多台机器已经**超量**出现70左右的单流录制，磁盘出现**过渡积压**



######当前情况

* 每日课量

  ![image-20190829145640981](/Users/wangyudi/Library/Application Support/typora-user-images/image-20190829145640981.png)

* 录制量

  ![image-20190829145658162](/Users/wangyudi/Library/Application Support/typora-user-images/image-20190829145658162.png)



* 说明

  图一为每天上课的数量，图二为录制表的数量；

  图二中数量有偏差，有的课不需要录制，有录制积压量算在第二天

  

  大约每天有**百分之二十左右**的高峰期时段没有录上，有的是机器满了满足不了录制需求，手动清盘丢失的数据。



#####  解决办法

###### 第三方回看

* 优点

  * 维护成本

    不用维护

  * 可靠性

    可以要求声网保证录制的可靠性。

* 缺点

  太贵了，20.4元/千分钟；合1.224/每小时



###### 加机器

按照**每台50个**并发录制，现在支持**900**。带宽如果加大可以提高并发，但是cpu和硬盘都需要提升，性价比太低。

顾增加**原有配置机器**，升级**磁盘1T**即可。

如果按照张超提供的数据，**未来半年**我们应该能达到**2000**同时上课数。

需要按照**现有配置**增加**22台**机器，方可满足未来半年的使用。

* 公式

2000（未来半年同时上课） / 50（每台机器支持数量） - 18（现有机器） = 22



###### 定时清理文件

如果出现磁盘占用不足，需要手动清理文件，但是清理文件**可能造成视频丢失**；

目前先**不需要写脚步清理**，加机器后看情况再添加清理。



###### 程序升级

如果要求高效无误的录制，需要对程序做升级，具体工期视情况而定。



#### 关于告警

正常情况下为保证录制课程正常和机器的高利用率，录制和专门会同时在机器上进行，有**少量机器**出现**磁盘告警**属于正常情况。

